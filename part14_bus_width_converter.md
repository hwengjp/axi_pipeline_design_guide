# AXIバス設計ガイド 第14回 バス幅変換

## 目次

  - [1. はじめに](#1-はじめに)
  - [2. バス幅変換の分析](#2-バス幅変換の分析)
    - [2.1 幅が増大するケース](#21-幅が増大するケース)
    - [2.2 幅が減少するケース](#22-幅が減少するケース)
  - [3. 設計方針とアーキテクチャ](#3-設計方針とアーキテクチャ)
    - [3.1 基本設計原則](#31-基本設計原則)
    - [3.2 パイプライン構成](#32-パイプライン構成)
    - [3.3 制御信号の設計](#33-制御信号の設計)
  - [4. 実装詳細](#4-実装詳細)
    - [4.1 上位ビットから下位ビットへの変換](#41-上位ビットから下位ビットへの変換)
    - [4.2 下位ビットから上位ビットへの変換](#42-下位ビットから上位ビットへの変換)
    - [4.3 ストローブ信号の処理](#43-ストローブ信号の処理)
  - [5. テストベンチと検証](#5-テストベンチと検証)
    - [5.1 テスト戦略](#51-テスト戦略)
    - [5.2 境界値テスト](#52-境界値テスト)
    - [5.3 パフォーマンス検証](#53-パフォーマンス検証)
  - [6. まとめ](#6-まとめ)
  - [ライセンス](#ライセンス)

## 1. はじめに

このドキュメントは、AXI4バス設計において重要な役割を果たすバス幅変換コンポーネントの実装について説明します。

第11回までで実装した拡張ストローブ制御機能を基盤として、異なるバス幅間でのデータ転送を効率的に処理するバス幅変換コンポーネントを設計・実装します。

### **第12回の主要なテーマ**

1. **バス幅変換の基本概念**: 異なるバス幅間でのデータ転送の原理
2. **設計方針とアーキテクチャ**: 効率的なバス幅変換の実現方法
3. **実装詳細**: 具体的な回路設計と制御ロジック
4. **テストベンチと検証**: 動作確認と品質保証の手法

### **バス幅変換コンポーネントの重要性**

現代のSoC設計において、異なるバス幅を持つIPコア間でのデータ転送は避けて通れない課題です。32ビットバスと64ビットバス、128ビットバスなど、様々なバス幅間での効率的なデータ転送を実現するバス幅変換コンポーネントは、システム全体の性能と柔軟性を大きく左右します。

このコンポーネントの実装により、AXI4バス設計の幅がさらに広がり、より柔軟で効率的なシステム設計が可能になります。

## 2. バス幅変換の分析

バス幅変換において、以下の2つの重要な方針を設定します：

#### **バースト転送の基本方針**

1. **バーストの分解を最小限に抑制**: バースト転送はできるだけ分解せずにバーストのまま転送する
2. **バブルフリー転送の実現**: バス幅を変換してもバブルが入らないようにする

これらの方針により、バス幅変換時のパフォーマンス低下を最小限に抑え、効率的なデータ転送を実現します。

### 2.1 幅が増大するケース

バス幅が増大するケース（例：32ビット→64ビット、64ビット→128ビット）について、ライトとリードに分けて分析します。

#### **ライト（Write）の分析**

**問題点**: バス幅増大によりバブルが入る可能性があります。

**対策**: 
STROBEを使用して同じビート数で処理
そのあとに２つのビートを１つにまとめる回路を挿入
バースト長のFIFOを用意して、データの流れを制御します。

**アドレス処理**:
- バス幅に合わせてアドレスサイクルを変換
- 基本的にはLENの変換を行う
- アドレスバウンダリがバス幅と合っていない場合は、STROBEで調整

#### **リード（Read）の分析**

**変換方向**: 下流のバス幅大から上流のバス幅小への変換

**対策**: バースト長のFIFOを用意して、データの流れを制御します。

**アドレス処理**:
- バス幅に合わせてアドレスサイクルを変換
- 基本的にはLENの変換を行う
- アドレスバウンダリがバス幅と合っていない場合は、不要なデータを捨てる

**データ捨て処理**:
- 捨てる操作は上流からのアドレスとLENで判定
- この判定のために、アドレスサイクルの情報を保持するFIFOが必要

### 2.2 幅が減少するケース

バス幅が減少するケース（例：64ビット→32ビット、128ビット→64ビット）について、ライトとリードに分けて分析します。

#### **ライト（Write）の分析**

**変換方向**: 上流のバス幅大から下流のバス幅小への変換

**問題点**: 上流から来る大きなデータを下流の小さなバス幅で処理する必要

**対策**: データ分割用のFIFOを用意して、上流の大きなデータを下流の小さなバス幅に分割します。

**アドレス処理**:
- バス幅に合わせてアドレスサイクルを変換
- 基本的にはLENの変換を行う
- 上流の大きなバス幅のデータを下流の小さなバス幅に分割

**データ分割処理**:
- 上流から来る大きなデータを分割
- 下流の小さなバス幅に合わせて適切にデータを分配
- バースト転送の完了を適切に判定

#### **リード（Read）の分析**

**変換方向**: 上流のバス幅大から下流のバス幅小への変換

**問題点**: 上流の大きなバス幅で要求されたデータを下流の小さなバス幅から効率的に取得する必要

**対策**: データ要求用のFIFOを用意して、上流の要求に合わせてデータを分割します。

**アドレス処理**:
- バス幅に合わせてアドレスサイクルを変換
- 基本的にはLENの変換を行う
- 上流の大きなバス幅の要求を下流の小さなバス幅に変換

**データ分割処理**:
- 下流の小さなバス幅からデータを取得
- 上流の要求に合わせて適切にデータを分割
- 不要なデータの読み出しを避ける制御

## ライセンス

Licensed under the Apache License, Version 2.0 - see [LICENSE](https://www.apache.org/licenses/LICENSE-2.0) file for details.
